¬¥<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLA Manager V8.0 - Central de Cobran√ßa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; -webkit-appearance: none; appearance: none; }
        /* Anima√ß√£o suave para o modal */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">

    <div id="modal-driver-select" class="fixed inset-0 bg-black/70 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden flex flex-col max-h-[80vh] fade-in">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold"><i class="fas fa-user-clock mr-2"></i> Selecione para Cobrar</h3>
                <button onclick="closeModal('modal-driver-select')" class="hover:bg-white/20 px-2 rounded"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 bg-slate-50 border-b">
                <p class="text-xs text-gray-500">Exibindo motoristas com pend√™ncias na cidade selecionada.</p>
            </div>
            <div id="driver-list-container" class="overflow-y-auto custom-scrollbar p-2 space-y-2">
                </div>
        </div>
    </div>

    <div id="modal-message" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden flex flex-col fade-in">
            <div class="bg-green-600 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold"><i class="fab fa-whatsapp mr-2"></i> Mensagem Pronta</h3>
                <button onclick="closeModal('modal-message')" class="hover:bg-white/20 px-2 rounded"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1">
                <textarea id="msg-area" class="w-full h-64 p-3 border rounded-lg text-xs font-mono bg-gray-50 focus:ring-2 focus:ring-green-500 outline-none resize-none" readonly></textarea>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end gap-2">
                <button onclick="closeModal('modal-message')" class="px-4 py-2 text-gray-500 text-xs font-bold hover:bg-gray-200 rounded">Cancelar</button>
                <button onclick="copyToClipboard()" class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white text-xs font-bold rounded shadow flex items-center">
                    <i class="fas fa-copy mr-2"></i> Copiar Texto
                </button>
            </div>
        </div>
    </div>

    <header class="bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto flex flex-col xl:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600/20 p-2 rounded-lg border border-indigo-500/30">
                    <i class="fas fa-tasks text-2xl text-indigo-400"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight uppercase">SLA Central V8</h1>
                    <p class="text-gray-400 text-[10px]">Gest√£o de Entregas & Cobran√ßa</p>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-2 w-full xl:w-auto items-center">
                <div class="flex flex-col w-full md:w-auto">
                    <label class="text-[9px] text-gray-400 font-bold uppercase ml-1 mb-1">Data (M)</label>
                    <input type="date" id="filterDate" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg p-2 focus:ring-blue-500 w-full md:w-36 font-bold h-[38px]">
                </div>

                <div class="flex flex-col w-full md:w-auto">
                    <label class="text-[9px] text-gray-400 font-bold uppercase ml-1 mb-1">Filtrar Cidade</label>
                    <select id="filterCity" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg p-2 focus:ring-blue-500 w-full md:w-48 font-bold h-[38px] cursor-pointer">
                        <option value="">Todas as Cidades</option>
                    </select>
                </div>

                <div class="flex items-center bg-slate-800 p-2 rounded-lg border border-slate-700 h-[38px] mt-4 md:mt-0">
                    <div class="relative inline-block w-8 mr-2 align-middle select-none">
                        <input type="checkbox" id="toggleQuiri" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0" checked/>
                        <label for="toggleQuiri" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-600 cursor-pointer"></label>
                    </div>
                    <label class="text-[10px] font-bold text-white cursor-pointer select-none">Regi√£o Quirin√≥polis</label>
                </div>

                <div class="flex gap-2">
                    <label class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg cursor-pointer text-xs font-bold transition shadow-lg flex items-center justify-center h-[38px] border border-blue-400 w-24">
                        <i class="fas fa-database mr-2"></i> Base
                        <input type="file" id="fileBase" accept=".xlsx, .xls, .csv" class="hidden"/>
                    </label>

                    <label class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg cursor-pointer text-xs font-bold transition shadow-lg flex items-center justify-center h-[38px] border border-slate-500 w-24 relative" title="Obrigat√≥rio para Cobran√ßa">
                        <i class="fas fa-sync-alt mr-2"></i> Atualizar
                        <input type="file" id="fileUpdate" accept=".xlsx, .xls, .csv" class="hidden"/>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 space-y-6 pb-20">
        
        <div id="initial-msg" class="py-20 text-center text-gray-400">
            <i class="fas fa-shipping-fast text-6xl mb-4 opacity-10"></i>
            <h2 class="text-xl font-bold">Painel de Opera√ß√µes</h2>
            <p class="text-sm">Carregue os arquivos para come√ßar.</p>
        </div>

        <div id="dashboard" class="hidden space-y-6">
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-slate-600">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Volume (Filtro)</p>
                    <h3 class="text-3xl font-black text-slate-800 mt-1" id="kpi-total">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-indigo-600">
                    <p class="text-[10px] text-indigo-600 font-bold uppercase">SLA Real</p>
                    <h3 class="text-3xl font-black text-indigo-600 mt-1" id="kpi-sla">0.0%</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-emerald-500">
                    <p class="text-[10px] text-emerald-600 font-bold uppercase">Entregues</p>
                    <h3 class="text-3xl font-black text-emerald-600 mt-1" id="kpi-entregue">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-blue-400">
                    <p class="text-[10px] text-blue-500 font-bold uppercase">Em Rota</p>
                    <h3 class="text-3xl font-black text-blue-500 mt-1" id="kpi-rota">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-red-500 bg-red-50">
                    <p class="text-[10px] text-red-600 font-bold uppercase">Pendentes</p>
                    <h3 class="text-3xl font-black text-red-600 mt-1" id="kpi-base">0</h3>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="bg-slate-800 p-4 text-white flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex flex-col">
                        <h3 class="font-bold text-xs uppercase flex items-center">
                            <i id="table-icon" class="fas fa-city mr-2 text-blue-400"></i> 
                            <span id="table-title">Vis√£o Geral</span>
                        </h3>
                        <span id="table-subtitle" class="text-[10px] text-slate-400 font-mono"></span>
                    </div>

                    <button id="btn-master-billing" onclick="openDriverSelector()" disabled class="hidden md:flex items-center gap-2 bg-gray-600 text-gray-300 px-4 py-2 rounded shadow-lg text-xs font-bold transition cursor-not-allowed opacity-50">
                        <i class="fab fa-whatsapp"></i>
                        <span>Carregue Arq 2 p/ Cobrar</span>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-100 text-slate-600 font-bold uppercase border-b">
                            <tr>
                                <th class="px-6 py-4" id="col-name">Nome</th>
                                <th class="px-4 py-4 text-center">Volume</th>
                                <th class="px-4 py-4 text-center text-emerald-600">Entregue</th>
                                <th class="px-4 py-4 text-center text-blue-500">Rota</th>
                                <th class="px-4 py-4 text-center text-red-600">Pend/Parado</th>
                                <th class="px-4 py-4 text-center text-orange-500">Falha</th>
                                <th class="px-6 py-4 text-right">SLA %</th>
                            </tr>
                        </thead>
                        <tbody id="main-table" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let baseData = [];
        let updateData = [];
        let hasUpdateFile = false; // Controle de estado
        const BLOCK_LIST = ["QUIRINOPOLIS", "SAO SIMAO", "ITARUMA", "PARANAIGUARA", "CACHOEIRA ALTA", "APORE", "GOUVELANDIA", "CACU", "INACIOLANDIA", "ITAJA", "APARECIDA DO RIO DOCE", "CASTELANDIA", "LAGOA SANTA"];

        // Setup Data Hoje
        const today = new Date();
        document.getElementById('filterDate').value = today.toISOString().split('T')[0];

        // Listeners
        document.getElementById('fileBase').addEventListener('change', (e) => handleFile(e, 'base'));
        document.getElementById('fileUpdate').addEventListener('change', (e) => handleFile(e, 'update'));
        document.getElementById('filterDate').addEventListener('change', runDashboard);
        document.getElementById('toggleQuiri').addEventListener('change', runDashboard);
        document.getElementById('filterCity').addEventListener('change', renderTable);

        function handleFile(e, type) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: false });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: "A", defval: "" });
                
                if(type === 'base') {
                    baseData = json;
                    document.getElementById('fileBase').parentElement.classList.add('bg-blue-800');
                    document.getElementById('fileBase').parentElement.innerHTML = `<i class="fas fa-check mr-2"></i> OK`;
                } else {
                    updateData = json;
                    hasUpdateFile = true; // Habilita cobran√ßa
                    const btn = document.getElementById('fileUpdate').parentElement;
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('bg-emerald-600');
                    btn.innerHTML = `<i class="fas fa-check-double mr-2"></i> OK <input type="file" id="fileUpdate" accept=".xlsx, .xls, .csv" class="hidden"/>`;
                    document.getElementById('fileUpdate').addEventListener('change', (ev) => handleFile(ev, 'update'));
                }
                runDashboard();
            };
            reader.readAsBinaryString(file);
        }

        function normalizeDate(input) {
            if (!input) return null;
            if (!isNaN(input) && Number(input) > 20000) {
                const date = new Date((Number(input) - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            let str = String(input).trim().toUpperCase();
            if (str.includes(' ')) str = str.split(' ')[0];
            if (str.includes('/')) {
                const parts = str.split('/');
                if (parts.length === 3) return `${parts[2].length==2?"20"+parts[2]:parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
            }
            if (str.includes('-')) return str.substring(0, 10);
            return null;
        }

        let currentProcessedData = []; 

        function runDashboard() {
            if(baseData.length === 0) return;
            
            const targetDate = document.getElementById('filterDate').value;
            const includeQuiri = document.getElementById('toggleQuiri').checked;
            
            document.getElementById('initial-msg').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            const updateMap = new Map();
            if(updateData.length > 0) {
                updateData.forEach(row => {
                    const id = String(row.A || "").trim();
                    if(id) {
                        updateMap.set(id, { 
                            driver: String(row.E || "").trim(), 
                            mark: String(row.K || "").toUpperCase(),
                            client: String(row.V || "CLIENTE N√ÉO IDENTIFICADO").trim()
                        });
                    }
                });
            }

            currentProcessedData = [];
            const citiesFound = new Set();

            baseData.forEach((row, idx) => {
                if(idx === 0) return; 

                const rowDate = normalizeDate(row.M);
                if (rowDate === targetDate) {
                    const cityRaw = String(row.AD || "").trim();
                    const cityNorm = cityRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();

                    if (!includeQuiri && BLOCK_LIST.includes(cityNorm)) return;
                    citiesFound.add(cityRaw);

                    const id = String(row.A || "").trim();
                    let status = 'BASE';
                    let clientName = "Sem Info"; 

                    if (String(row.Q || "").trim() !== "") status = 'ENTREGUE';
                    else if (String(row.S || "").trim() !== "") status = 'FALHA';
                    else if (String(row.P || "").trim() !== "") status = 'ROTA';

                    let driver = String(row.P || "SEM MOTORISTA").toUpperCase().trim();

                    if (updateMap.has(id)) {
                        const up = updateMap.get(id);
                        clientName = up.client; 
                        if (up.mark.includes("RECEBIMENTO") || up.mark.includes("ENTREGUE")) status = 'ENTREGUE';
                        else if (up.mark.includes("NAO ENTREGUE")) status = 'FALHA';
                        else if (up.driver !== "" && status === 'BASE') {
                            status = 'ROTA';
                            driver = up.driver.toUpperCase(); 
                        }
                    }
                    currentProcessedData.push({ id, city: cityRaw, driver, status, client: clientName });
                }
            });

            const sel = document.getElementById('filterCity');
            const savedVal = sel.value;
            sel.innerHTML = '<option value="">Todas as Cidades</option>';
            Array.from(citiesFound).sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            sel.value = citiesFound.has(savedVal) ? savedVal : "";

            renderTable();
        }

        function renderTable() {
            const filterCity = document.getElementById('filterCity').value;
            
            // SETUP UI
            const isDriverMode = filterCity !== "";
            
            // ATUALIZA√á√ÉO DO BOT√ÉO MESTRE
            const btnMaster = document.getElementById('btn-master-billing');
            if (isDriverMode && hasUpdateFile) {
                btnMaster.disabled = false;
                btnMaster.className = "hidden md:flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded shadow-lg text-xs font-bold transition transform active:scale-95";
                btnMaster.innerHTML = `<i class="fab fa-whatsapp text-lg"></i> <span>Gerar Cobran√ßa (${filterCity})</span>`;
            } else {
                btnMaster.disabled = true;
                btnMaster.className = "hidden md:flex items-center gap-2 bg-gray-600 text-gray-400 px-4 py-2 rounded shadow-lg text-xs font-bold transition cursor-not-allowed opacity-50";
                btnMaster.innerHTML = `<i class="fab fa-whatsapp text-lg"></i> <span>${hasUpdateFile ? 'Selecione uma Cidade' : 'Carregue Arq 2 p/ Cobrar'}</span>`;
            }

            if (isDriverMode) {
                document.getElementById('table-title').innerText = `Motoristas: ${filterCity}`;
                document.getElementById('table-icon').className = "fas fa-user-tie mr-2 text-orange-400";
                document.getElementById('col-name').innerText = "Motorista";
            } else {
                document.getElementById('table-title').innerText = "Vis√£o Geral por Cidade";
                document.getElementById('table-icon').className = "fas fa-city mr-2 text-blue-400";
                document.getElementById('col-name').innerText = "Cidade";
            }

            let data = currentProcessedData;
            if(isDriverMode) data = data.filter(d => d.city === filterCity);

            const stats = {};
            let gStats = {vol:0, ent:0, rota:0, base:0, falha:0};

            data.forEach(d => {
                const key = isDriverMode ? d.driver : d.city;
                if(!stats[key]) stats[key] = { name: key, vol:0, ent:0, rota:0, base:0, falha:0 };
                stats[key].vol++; gStats.vol++;
                if(d.status === 'ENTREGUE') { stats[key].ent++; gStats.ent++; }
                else if(d.status === 'ROTA') { stats[key].rota++; gStats.rota++; }
                else if(d.status === 'FALHA') { stats[key].falha++; gStats.falha++; }
                else { stats[key].base++; gStats.base++; }
            });

            document.getElementById('kpi-total').innerText = gStats.vol;
            document.getElementById('kpi-entregue').innerText = gStats.ent;
            document.getElementById('kpi-rota').innerText = gStats.rota;
            document.getElementById('kpi-base').innerText = gStats.base;
            document.getElementById('kpi-sla').innerText = gStats.vol > 0 ? ((gStats.ent/gStats.vol)*100).toFixed(1)+"%" : "0.0%";

            const tbody = document.getElementById('main-table');
            const sorted = Object.values(stats).sort((a,b) => b.vol - a.vol);

            tbody.innerHTML = sorted.map(row => {
                const sla = row.vol > 0 ? ((row.ent/row.vol)*100).toFixed(0) : 0;
                return `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="px-6 py-3 font-bold text-slate-700 truncate max-w-xs">${row.name}</td>
                    <td class="px-4 py-3 text-center font-mono">${row.vol}</td>
                    <td class="px-4 py-3 text-center text-emerald-600 font-bold">${row.ent}</td>
                    <td class="px-4 py-3 text-center text-blue-500 font-semibold">${row.rota}</td>
                    <td class="px-4 py-3 text-center text-red-600 font-bold">${row.base}</td>
                    <td class="px-4 py-3 text-center text-orange-500">${row.falha}</td>
                    <td class="px-6 py-3 text-right font-black text-slate-800">${sla}%</td>
                </tr>`;
            }).join('');
        }

        // --- L√ìGICA DE COBRAN√áA ---

        function openDriverSelector() {
            const cityName = document.getElementById('filterCity').value;
            const container = document.getElementById('driver-list-container');
            container.innerHTML = '';

            // Agrupar motoristas com pend√™ncias
            const pendingByDriver = {};
            currentProcessedData.filter(d => d.city === cityName && d.status !== 'ENTREGUE').forEach(d => {
                if(!pendingByDriver[d.driver]) pendingByDriver[d.driver] = 0;
                pendingByDriver[d.driver]++;
            });

            const drivers = Object.entries(pendingByDriver).sort((a,b) => b[1] - a[1]);

            if(drivers.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-400">Nenhum motorista com pend√™ncia nesta cidade!</div>';
            } else {
                drivers.forEach(([driver, count]) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left bg-white border border-gray-200 hover:bg-green-50 hover:border-green-300 p-3 rounded shadow-sm flex justify-between items-center transition";
                    btn.onclick = () => generateMessage(driver);
                    btn.innerHTML = `
                        <span class="font-bold text-sm text-gray-700">${driver}</span>
                        <span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold">${count} pendentes</span>
                    `;
                    container.appendChild(btn);
                });
            }

            document.getElementById('modal-driver-select').classList.remove('hidden');
        }

        function generateMessage(driverName) {
            const cityName = document.getElementById('filterCity').value;
            const pending = currentProcessedData.filter(d => d.city === cityName && d.driver === driverName && d.status !== 'ENTREGUE');
            
            let msg = `üö® *RELAT√ìRIO DE PEND√äNCIAS* üö®\n`;
            msg += `üë§ Motorista: *${driverName}*\n`;
            msg += `üìç Cidade: *${cityName}*\n`;
            msg += `üìÖ Data: *${document.getElementById('filterDate').value.split('-').reverse().join('/')}*\n\n`;
            msg += `*Favor verificar os pacotes abaixo:*\n\n`;

            pending.forEach(p => {
                let icon = p.status === 'ROTA' ? 'üöö' : (p.status === 'FALHA' ? '‚ö†Ô∏è' : 'üè≠');
                msg += `${icon} *${p.id}* - ${p.client}\n`;
            });

            msg += `\nüî¥ *Total Pendente: ${pending.length}*`;

            document.getElementById('msg-area').value = msg;
            closeModal('modal-driver-select');
            document.getElementById('modal-message').classList.remove('hidden');
        }

        function copyToClipboard() {
            const textArea = document.getElementById('msg-area');
            textArea.select();
            navigator.clipboard.writeText(textArea.value).then(() => {
                const btn = document.querySelector('#modal-message button i.fa-copy').parentElement;
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-check mr-2"></i> Copiado!`;
                btn.classList.replace('bg-green-600', 'bg-slate-700');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-slate-700', 'bg-green-600');
                    closeModal('modal-message');
                }, 1000);
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        window.closeModal = closeModal; window.openDriverSelector = openDriverSelector; window.generateMessage = generateMessage; window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>