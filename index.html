<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLA Control - V7.7 (Completo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .debug-box { font-family: monospace; font-size: 10px; max-height: 80px; overflow-y: auto; background: #1e293b; color: #4ade80; padding: 8px; border-radius: 4px; margin-top: 5px; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">

    <header class="bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto flex flex-col xl:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600/20 p-2 rounded-lg border border-blue-500/30">
                    <i class="fas fa-satellite-dish text-2xl text-blue-400"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight uppercase">SLA & Tracking Real</h1>
                    <p class="text-gray-400 text-[10px]">Base (Planejado) + Atualização (Real)</p>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-3 w-full xl:w-auto items-center">
                <div class="flex flex-col w-full md:w-auto">
                    <label class="text-[9px] text-gray-400 font-bold uppercase ml-1 mb-1">Data Alvo (M)</label>
                    <input type="date" id="filterDate" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg p-2 focus:ring-blue-500 w-full md:w-40 font-bold h-[38px]">
                </div>

                <div class="flex items-center bg-slate-800 p-2 rounded-lg border border-slate-700 h-[38px]">
                    <div class="relative inline-block w-8 mr-2 align-middle select-none">
                        <input type="checkbox" id="toggleQuiri" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0" checked/>
                        <label for="toggleQuiri" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-600 cursor-pointer"></label>
                    </div>
                    <label class="text-[10px] font-bold text-white cursor-pointer select-none whitespace-nowrap">Região Quirinópolis</label>
                </div>

                <div class="flex gap-2">
                    <label class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg cursor-pointer text-xs font-bold transition shadow-lg flex items-center justify-center h-[38px] border border-blue-400">
                        <i class="fas fa-database mr-2"></i> 1. Base
                        <input type="file" id="fileBase" accept=".xlsx, .xls, .csv" class="hidden"/>
                    </label>

                    <label class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg cursor-pointer text-xs font-bold transition shadow-lg flex items-center justify-center h-[38px] border border-slate-500 relative">
                        <i class="fas fa-sync-alt mr-2"></i> 2. Atualizar
                        <input type="file" id="fileUpdate" accept=".xlsx, .xls, .csv" class="hidden"/>
                        <span id="update-dot" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 space-y-6 pb-20">
        
        <div id="diagnostico" class="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500 hidden">
            <h3 class="text-xs font-bold text-gray-700 uppercase mb-2"><i class="fas fa-info-circle mr-2"></i> Resumo da Operação</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <p class="text-[10px] text-gray-400">Pacotes na Data</p>
                    <p class="text-lg font-bold text-gray-800" id="diag-filtered">0</p>
                </div>
                <div>
                    <p class="text-[10px] text-gray-400">Atualizados via Arq. 2</p>
                    <p class="text-lg font-bold text-emerald-600" id="diag-updated">0</p>
                </div>
                <div class="col-span-2">
                    <p class="text-[10px] text-gray-400">Status da Leitura de Data</p>
                    <div id="diag-msg" class="text-xs font-mono text-purple-600 font-bold">Aguardando...</div>
                </div>
            </div>
        </div>

        <div id="initial-msg" class="py-20 text-center text-gray-400">
            <i class="fas fa-tasks text-6xl mb-4 opacity-10"></i>
            <h2 class="text-xl font-bold">Painel de Controle Diário</h2>
            <p class="text-sm">Carregue a Base (1) e opcionalmente o Status (2).</p>
        </div>

        <div id="dashboard" class="hidden space-y-6">
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-slate-600">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Volume Total</p>
                    <h3 class="text-3xl font-black text-slate-800 mt-1" id="kpi-total">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-indigo-600">
                    <p class="text-[10px] text-indigo-600 font-bold uppercase">SLA %</p>
                    <h3 class="text-3xl font-black text-indigo-600 mt-1" id="kpi-sla">0.0%</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-emerald-500">
                    <p class="text-[10px] text-emerald-600 font-bold uppercase">Entregues</p>
                    <h3 class="text-3xl font-black text-emerald-600 mt-1" id="kpi-entregue">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-blue-400">
                    <p class="text-[10px] text-blue-500 font-bold uppercase">Em Rota</p>
                    <h3 class="text-3xl font-black text-blue-500 mt-1" id="kpi-rota">0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-b-4 border-red-500 bg-red-50">
                    <p class="text-[10px] text-red-600 font-bold uppercase">Parados Base</p>
                    <h3 class="text-3xl font-black text-red-600 mt-1" id="kpi-base">0</h3>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                    <h3 class="font-bold text-xs uppercase"><i class="fas fa-list mr-2"></i> Detalhe por Cidade</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-slate-100 text-slate-600 font-bold uppercase border-b">
                            <tr>
                                <th class="px-6 py-4">Cidade</th>
                                <th class="px-4 py-4 text-center">Volume</th>
                                <th class="px-4 py-4 text-center text-emerald-600">Entregue</th>
                                <th class="px-4 py-4 text-center text-blue-500">Rota</th>
                                <th class="px-4 py-4 text-center text-red-600">Parado</th>
                                <th class="px-4 py-4 text-center text-orange-500">Falha</th>
                                <th class="px-6 py-4 text-right">SLA %</th>
                            </tr>
                        </thead>
                        <tbody id="main-table" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let baseData = [];
        let updateData = [];
        const BLOCK_LIST = ["QUIRINOPOLIS", "SAO SIMAO", "ITARUMA", "PARANAIGUARA", "CACHOEIRA ALTA", "APORE", "GOUVELANDIA", "CACU", "INACIOLANDIA", "ITAJA", "APARECIDA DO RIO DOCE", "CASTELANDIA", "LAGOA SANTA"];

        // Data Default = Hoje
        const today = new Date();
        const defDate = today.toISOString().split('T')[0];
        document.getElementById('filterDate').value = defDate;

        // Listeners
        document.getElementById('fileBase').addEventListener('change', (e) => handleFile(e, 'base'));
        document.getElementById('fileUpdate').addEventListener('change', (e) => handleFile(e, 'update'));
        document.getElementById('filterDate').addEventListener('change', runDashboard);
        document.getElementById('toggleQuiri').addEventListener('change', runDashboard);

        function handleFile(e, type) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const workbook = XLSX.read(evt.target.result, { type: 'binary', cellDates: false });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: "A", defval: "" });
                
                if(type === 'base') {
                    baseData = json;
                    const btn = document.getElementById('fileBase').parentElement;
                    btn.classList.add('bg-blue-800');
                    btn.innerHTML = `<i class="fas fa-check mr-2"></i> Base OK`;
                } else {
                    updateData = json;
                    const btn = document.getElementById('fileUpdate').parentElement;
                    btn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
                    btn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                    btn.innerHTML = `<i class="fas fa-check-double mr-2"></i> Atualizado <input type="file" id="fileUpdate" accept=".xlsx, .xls, .csv" class="hidden"/>`;
                    // Rebind listener
                    document.getElementById('fileUpdate').addEventListener('change', (ev) => handleFile(ev, 'update'));
                }
                runDashboard();
            };
            reader.readAsBinaryString(file);
        }

        // Função "Blindada" de Data
        function normalizeDate(input) {
            if (!input) return null;
            if (!isNaN(input) && Number(input) > 20000) {
                const date = new Date((Number(input) - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            let str = String(input).trim().toUpperCase();
            if (str.includes(' ')) str = str.split(' ')[0];
            if (str.includes('/')) {
                const parts = str.split('/');
                if (parts.length === 3) return `${parts[2].length==2?"20"+parts[2]:parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
            }
            if (str.includes('-')) return str.substring(0, 10);
            return null;
        }

        function runDashboard() {
            if(baseData.length === 0) return;
            
            const targetDate = document.getElementById('filterDate').value;
            const includeQuiri = document.getElementById('toggleQuiri').checked;
            
            document.getElementById('initial-msg').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('diagnostico').classList.remove('hidden');

            // Preparar Mapa de Atualização (Otimização)
            const updateMap = new Map();
            if(updateData.length > 0) {
                updateData.forEach(row => {
                    const id = String(row.A || "").trim();
                    if(id) {
                        updateMap.set(id, { 
                            driver: String(row.E || "").trim(), 
                            mark: String(row.K || "").toUpperCase() 
                        });
                    }
                });
            }

            let filteredCount = 0;
            let updatedCount = 0;
            const cities = {};

            // Loop Principal (Base)
            baseData.forEach((row, idx) => {
                if(idx === 0) return; // Header

                const rowDate = normalizeDate(row.M);
                if (rowDate === targetDate) {
                    const cityRaw = String(row.AD || "").trim();
                    const cityNorm = cityRaw.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();

                    if (!includeQuiri && BLOCK_LIST.includes(cityNorm)) return;

                    filteredCount++;

                    // 1. Status Base
                    let status = 'BASE';
                    const id = String(row.A || "").trim();
                    const baseHora = String(row.Q || "").trim();
                    const baseMotor = String(row.P || "").trim();
                    const baseProb = String(row.S || "").trim();

                    if (baseHora !== "") status = 'ENTREGUE';
                    else if (baseProb !== "") status = 'FALHA';
                    else if (baseMotor !== "") status = 'ROTA';

                    // 2. Tentar Atualização (Se status não for entregue definitivo na base, ou para confirmar)
                    if (updateMap.has(id)) {
                        const up = updateMap.get(id);
                        
                        // Lógica de Prioridade:
                        // Se arquivo 2 diz Entregue, vira Entregue.
                        if (up.mark.includes("RECEBIMENTO") || up.mark.includes("ASSINATURA") || up.mark.includes("ENTREGUE")) {
                            if(status !== 'ENTREGUE') updatedCount++;
                            status = 'ENTREGUE';
                        }
                        // Se arquivo 2 diz Não Entregue, vira Falha.
                        else if (up.mark.includes("NAO ENTREGUE") || up.mark.includes("DEVOLVIDO")) {
                            status = 'FALHA';
                        }
                        // Se arquivo 2 tem motorista e status atual ainda é Base, vira Rota.
                        else if (up.driver !== "" && status === 'BASE') {
                            updatedCount++;
                            status = 'ROTA';
                        }
                    }

                    // Contabilizar
                    if(!cities[cityRaw]) cities[cityRaw] = { name: cityRaw, vol: 0, ent: 0, rota: 0, base: 0, falha: 0 };
                    const c = cities[cityRaw];
                    c.vol++;
                    if(status === 'ENTREGUE') c.ent++;
                    else if(status === 'ROTA') c.rota++;
                    else if(status === 'FALHA') c.falha++;
                    else c.base++;
                }
            });

            // Atualizar Painel Diagnóstico
            document.getElementById('diag-filtered').innerText = filteredCount;
            document.getElementById('diag-updated').innerText = updatedCount;
            document.getElementById('diag-msg').innerText = `Visualizando dados de: ${targetDate}`;

            // Totais
            let tVol=0, tEnt=0, tRota=0, tBase=0, tFalha=0;
            Object.values(cities).forEach(c => {
                tVol += c.vol; tEnt += c.ent; tRota += c.rota; tBase += c.base; tFalha += c.falha;
            });

            document.getElementById('kpi-total').innerText = tVol;
            document.getElementById('kpi-entregue').innerText = tEnt;
            document.getElementById('kpi-rota').innerText = tRota;
            document.getElementById('kpi-base').innerText = tBase;
            document.getElementById('kpi-sla').innerText = tVol > 0 ? ((tEnt / tVol) * 100).toFixed(1) + "%" : "0.0%";

            // Tabela
            const sorted = Object.values(cities).sort((a,b) => b.vol - a.vol);
            document.getElementById('main-table').innerHTML = sorted.map(c => `
                <tr class="hover:bg-slate-50 border-b">
                    <td class="px-6 py-3 font-bold text-slate-700">${c.name}</td>
                    <td class="px-4 py-3 text-center font-mono">${c.vol}</td>
                    <td class="px-4 py-3 text-center text-emerald-600 font-bold">${c.ent}</td>
                    <td class="px-4 py-3 text-center text-blue-500 font-semibold">${c.rota}</td>
                    <td class="px-4 py-3 text-center text-red-600 font-bold ${c.base > 0 ? 'bg-red-50' : ''}">${c.base}</td>
                    <td class="px-4 py-3 text-center text-orange-500">${c.falha}</td>
                    <td class="px-6 py-3 text-right font-black text-slate-900">${c.vol > 0 ? ((c.ent/c.vol)*100).toFixed(0) : 0}%</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>